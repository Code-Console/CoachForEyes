<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>STL viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        margin: 0;
      }
      #c {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
      }
      .ui-container {
        display: flex;
        flex-direction: row;
        text-align: center;
      }
      .ui-child {
        width: 48%;
        height: 50px;
        background: radial-gradient(
          circle,
          rgba(175, 175, 175, 1) 0%,
          rgba(125, 125, 125, 1) 100%
        );
        margin: 0 1%;
        border-radius: 4px;
        display: flex;
        flex-direction: column;
      }
      .loader {
        border: 16px solid #f3f3f3; /* Light grey */
        border-top: 16px solid #3498db; /* Blue */
        border-radius: 50%;
        width: 120px;
        height: 120px;
        position: fixed;
        left: calc(50% - 120px);
        top: calc(50% - 120px);
        animation: spin 2s linear infinite;
      }
      .progress {
        position: fixed;
        left: calc(50% - 60px);
        top: calc(50% - 50px);
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
    <script src="https://unpkg.com/three@0.146.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.146.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/three@0.146.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://unpkg.com/three@0.146.0/examples/js/loaders/RGBELoader.js"></script>
  </head>
  <body>
    <canvas id="c"></canvas>
    <div class="ui-container">
      <div class="ui-child">
        <div>PreTreatment</div>
        <div class="sub-child">
          Mandibular
          <input
            type="checkbox"
            id="preMandibular"
            name="preMandibular"
            value="preMandibular"
            checked
            onchange="handleClick()"
            disabled
          />
          Maxillary
          <input
            type="checkbox"
            id="preMaxillary"
            name="preMaxillary"
            value="preMaxillary"
            checked
            onchange="handleClick()"
            disabled
          />
        </div>
      </div>
      <div class="ui-child">
        <div>PostTreatment</div>
        <div class="sub-child">
          Mandibular
          <input
            type="checkbox"
            id="postMandibular"
            name="postMandibular"
            value="postMandibular"
            onchange="handleClick()"
            disabled
          />
          Maxillary
          <input
            type="checkbox"
            id="postMaxillary"
            name="postMaxillary"
            value="postMaxillary"
            onchange="handleClick()"
            disabled
          />
        </div>
      </div>
    </div>

    <div id="loader" class="loader"></div>
    <div id="progress" class="progress">0%</div>

    <script>
      const postMandibularUrl = "./assets/PostTreatment_Mandibular.stl";
      const postMaxillaryUrl = "./assets/PostTreatment_Maxillary.stl";
      const preMandibularUrl = "./assets/PreTreatment_Mandibular.stl";
      const preMaxillaryUrl = "./assets/PreTreatment_Maxillary.stl";
      const envHDRUrl = "./assets/env.hdr";

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      const canvas = document.querySelector("#c");
      let isObjectsLoaded = false;
      const loadModel = () => {
        document.getElementById("loader").style.display = "none";
        document.getElementById("progress").style.display = "none";
        document.querySelector("#preMandibular").disabled = false;
        document.querySelector("#preMaxillary").disabled = false;
        document.querySelector("#postMandibular").disabled = false;
        document.querySelector("#postMaxillary").disabled = false;
        isObjectsLoaded = true;
      };
      const manager = new THREE.LoadingManager(loadModel);
      manager.onProgress = function (item, loaded, total) {
        document.getElementById("progress").innerHTML =
          (loaded / total) * 100 + "%";
      };
      const renderer = new THREE.WebGLRenderer({
        canvas,
        antialias: true,
        alpha: true,
      });
      let preMandibularMesh;
      let preMaxillaryMesh;
      let postMandibularMesh;
      let postMaxillaryMesh;
      const handleClick = () => {
        if (!isObjectsLoaded) return;
        const preMandibular = document.querySelector("#preMandibular").checked;
        const preMaxillary = document.querySelector("#preMaxillary").checked;
        const postMandibular =
          document.querySelector("#postMandibular").checked;
        const postMaxillary = document.querySelector("#postMaxillary").checked;
        if (preMandibularMesh) preMandibularMesh.visible = preMandibular;
        if (preMaxillaryMesh) preMaxillaryMesh.visible = preMaxillary;
        if (postMandibularMesh) postMandibularMesh.visible = postMandibular;
        if (postMaxillaryMesh) postMaxillaryMesh.visible = postMaxillary;
      };

      function addShadowedLight(x, y, z, color, intensity) {
        const directionalLight = new THREE.DirectionalLight(color, intensity);
        directionalLight.position.set(x, y, z);
        scene.add(directionalLight);
        directionalLight.castShadow = true;
        const d = 1;
        directionalLight.shadow.camera.left = -d;
        directionalLight.shadow.camera.right = d;
        directionalLight.shadow.camera.top = d;
        directionalLight.shadow.camera.bottom = -d;
        directionalLight.shadow.camera.near = 1;
        directionalLight.shadow.camera.far = 4;
        directionalLight.shadow.bias = -0.002;
      }
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setClearColor(0x424242, 1);
      renderer.outputEncoding = THREE.sRGBEncoding;
      renderer.shadowMap.enabled = true;
      const onWindowResize = () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      };

      window.addEventListener("resize", onWindowResize, false);
      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      camera.position.set(0, 1, 5);
      controls.update();
      const rgbeLoader = new THREE.RGBELoader();
      rgbeLoader.load(
        envHDRUrl,
        (texture) => {
          if (renderer && scene) {
            let pmremGenerator = new THREE.PMREMGenerator(renderer);
            pmremGenerator.compileEquirectangularShader();
            const envMap = pmremGenerator.fromEquirectangular(texture).texture;
            pmremGenerator = undefined;
            scene.environment = envMap;
          }
        },
        undefined,
        undefined
      );
      const loader = new THREE.STLLoader(manager);
      loader.load(postMandibularUrl, function (geometry) {
        const material = new THREE.MeshPhongMaterial({
          color: 0xffffff,
          specular: 0x111111,

          flatShading: true,
          smoothShading: true,
        });
        const mesh = new THREE.Mesh(geometry, material);
        mesh.scale.set(0.05, 0.05, 0.05);
        mesh.castShadow = true;
        mesh.receiveShadow = true;
        scene.add(mesh);
        postMandibularMesh = mesh;
        postMandibularMesh.visible = false;
      });
      loader.load(postMaxillaryUrl, function (geometry) {
        const material = new THREE.MeshPhongMaterial({
          color: 0xffffff,
          specular: 0x111111,

          flatShading: true,
          smoothShading: true,
        });
        const mesh = new THREE.Mesh(geometry, material);
        mesh.scale.set(0.05, 0.05, 0.05);
        mesh.castShadow = true;
        mesh.receiveShadow = true;
        scene.add(mesh);
        postMaxillaryMesh = mesh;
        postMaxillaryMesh.visible = false;
      });
      loader.load(preMandibularUrl, function (geometry) {
        const material = new THREE.MeshPhongMaterial({
          color: 0xffffff,
          specular: 0x111111,

          flatShading: true,
          smoothShading: true,
        });
        const mesh = new THREE.Mesh(geometry, material);
        mesh.scale.set(0.05, 0.05, 0.05);
        mesh.castShadow = true;
        mesh.receiveShadow = true;
        scene.add(mesh);
        preMandibularMesh = mesh;
      });
      loader.load(preMaxillaryUrl, function (geometry) {
        const material = new THREE.MeshPhongMaterial({
          color: 0xffffff,
          specular: 0x111111,

          flatShading: true,
          smoothShading: true,
        });
        const mesh = new THREE.Mesh(geometry, material);
        mesh.scale.set(0.05, 0.05, 0.05);
        mesh.castShadow = true;
        mesh.receiveShadow = true;
        scene.add(mesh);
        preMaxillaryMesh = mesh;
      });

      addShadowedLight(1, 1, 1, 0xffffff, 0.5);
      const light = new THREE.AmbientLight(0xffffff, 0.5); // soft white light
      scene.add(light);
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.51); // soft white light
      scene.add(directionalLight);

      let counter = 0;

      function animate() {
        counter += 1;
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      }
      animate();
    </script>
  </body>
</html>
